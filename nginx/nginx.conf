worker_processes auto;
events { worker_connections 2048; }

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 10m;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=admin:10m rate=10r/s;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" rt=$request_time';
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # Upstream servers
    upstream registry { server registry:3001; }
    upstream gateway { server gateway:3002; }
    upstream admin { server admin:3003; }
    upstream bap { server bap:3004; }
    upstream bpp { server bpp:3005; }
    upstream docs { server docs:3000; }
    upstream vault { server vault:3006; }
    upstream orchestrator { server orchestrator:3007; }
    upstream health-monitor { server health-monitor:3008; }
    upstream log-aggregator { server log-aggregator:3009; }
    upstream mock-server { server mock-server:3010; }
    upstream simulation-engine { server simulation-engine:3011; }

    # Shared proxy settings
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Docs/Landing — ondc.dmj.one
    server {
        listen 80;
        server_name ondc.dmj.one;
        location / { proxy_pass http://docs; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # Registry — registry.ondc.dmj.one
    server {
        listen 80;
        server_name registry.ondc.dmj.one;
        limit_req zone=api burst=50 nodelay;
        location / { proxy_pass http://registry; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # Gateway — gateway.ondc.dmj.one
    server {
        listen 80;
        server_name gateway.ondc.dmj.one;
        limit_req zone=api burst=50 nodelay;
        location / { proxy_pass http://gateway; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # Admin — admin.ondc.dmj.one
    server {
        listen 80;
        server_name admin.ondc.dmj.one;
        limit_req zone=admin burst=20 nodelay;

        location / { proxy_pass http://admin; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

        # WebSocket support for real-time updates
        location /api/ws {
            proxy_pass http://orchestrator;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 86400;
        }
    }

    # BAP — bap.ondc.dmj.one
    server {
        listen 80;
        server_name bap.ondc.dmj.one;
        limit_req zone=api burst=50 nodelay;
        location / { proxy_pass http://bap; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # BPP — bpp.ondc.dmj.one
    server {
        listen 80;
        server_name bpp.ondc.dmj.one;
        limit_req zone=api burst=50 nodelay;
        location / { proxy_pass http://bpp; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # Vault — vault.ondc.dmj.one (internal only in production)
    server {
        listen 80;
        server_name vault.ondc.dmj.one;
        limit_req zone=admin burst=10 nodelay;
        location / { proxy_pass http://vault; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    }

    # Orchestrator — orchestrator.ondc.dmj.one (internal only in production)
    server {
        listen 80;
        server_name orchestrator.ondc.dmj.one;
        limit_req zone=admin burst=10 nodelay;

        location / { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

        # WebSocket support
        location /ws {
            proxy_pass http://orchestrator;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 86400;
        }
    }

    # Default — catch-all
    server {
        listen 80 default_server;
        server_name _;

        # Nginx health check endpoint (used by Docker healthcheck)
        location /health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"ok","service":"nginx"}';
        }

        location / { return 301 http://ondc.dmj.one$request_uri; }
    }
}
